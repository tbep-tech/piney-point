---
output: 
  html_document:
    code_folding: hide
css: styles.css
---

# Chlorophyll interpolation

```{r setup, message = F, warning = F, results = 'hide', echo = T, warning = F}

knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = T)

library(tidyverse)
library(lubridate)
library(sf)
library(tbeptools)
library(gstat)
library(sp)
library(mapview)
library(leaflet)
library(raster)

data(rswqdat)
data(rsstatloc)

seg <- tbseg %>% 
  st_geometry() %>% 
  as_Spatial()
shed <- tbsegshed %>% 
  filter(bay_segment %in% c('LTB', 'TCB', 'MTB')) %>% 
  st_union() %>% 
  st_geometry() %>% 
  as_Spatial()

# empty grid for interpolation
grd <- as.data.frame(spsample(shed, "regular", n = 100000))
names(grd) <- c("X", "Y")
coordinates(grd) <- c("X", "Y")
gridded(grd) <- TRUE  # Create SpatialPixel object
fullgrid(grd) <- TRUE  # Create SpatialGrid object

# non-bay stations
nonbay <- c('BH01', 'P Port 2', 'P Port 3', 'PM Out', '20120409-01', 'PPC41', 'P Port 4', 'PMB01')

locs <- rsstatloc %>% 
  dplyr::select(station)

chldat <- rswqdat %>%
  filter(!station %in% nonbay) %>% 
  filter(var %in% 'chla') %>% 
  dplyr::select(station, date, var, val) %>% 
  inner_join(locs, ., by = 'station') %>% 
  mutate(
    date = floor_date(date, unit = 'week')
  )

colfun <- colorNumeric(
  RColorBrewer::brewer.pal(9, 'Blues'),
  domain = c(0, max(chldat$val, na.rm = T)),
  na.color = "#FFFFFF00" ,
  alpha = FALSE,
  reverse = FALSE
)

colfun2 <- colorBin(
  RColorBrewer::brewer.pal(9, 'Blues'),
  domain = c(0, max(chldat$val, na.rm = T)), 
  bins = 10,
  na.color = "#FFFFFF00" ,
  alpha = FALSE,
  reverse = FALSE
)

wk <- chldat %>% 
  filter(date == as.Date('2021-04-04')) %>% 
  mutate(
    col = colfun(val)
  )

wkspa <- wk %>% 
  as_Spatial

bbox <- chldat %>% 
  st_bbox %>% 
  st_as_sfc() %>% 
  st_as_sf() %>% 
  as_Spatial()

# add crs to grid
proj4string(wkspa) <- proj4string(wkspa)
proj4string(grd) <- proj4string(wkspa)

# Create an empty grid where n is the total number of cells
# Interpolate the grid cells using a power value of 2 (idp=2.0)
wkspa.idw <- gstat::idw(val ~ 1, wkspa, newdata = grd, idp = 3.0)

# Convert to raster object then clip by relevant boundaries
r <- raster(wkspa.idw)
r.m <- crop(r, bbox)
r.m <- mask(r.m, seg)
```

### Week of 2021-04-04

```{r, out.width = '100%'}
mapview(wk, homebutton = F, legend = F) %>% 
  .@map %>% 
  clearMarkers() %>% 
  addRasterImage(r.m, colors = colfun2) %>% 
  addCircleMarkers(
    data = wk,
    stroke = TRUE,
    color = 'black',
    fill = TRUE,
    fillColor = wk$col,
    weight = 0.5,
    fillOpacity = 1,
    radius= 3,
    label = ~val
  ) %>%
  addLegend("topright", title = 'Chla (ug/L)', opacity = 1, values = chldat$val, pal = colfun2)
```