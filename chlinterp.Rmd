---
output: 
  html_document:
    code_folding: hide
css: styles.css
---

# Chlorophyll interpolation

```{r setup, message = F, warning = F, results = 'hide', echo = T, warning = F}

knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = T)

library(tidyverse)
library(lubridate)
library(sf)
library(tbeptools)
library(gstat)
library(sp)
library(mapview)
library(leaflet)
library(raster)

data(rswqdat)
data(rsstatloc)
data(segmask)

prj <- "+proj=longlat +datum=WGS84 +no_defs"

# non-bay stations
nonbay <- c('BH01', 'P Port 2', 'P Port 3', 'PM Out', '20120409-01', 'PPC41', 'P Port 4', 'PMB01')

# station locations
locs <- rsstatloc %>% 
  dplyr::select(station)

# current chl data
chldat <- rswqdat %>%
  filter(!station %in% nonbay) %>% 
  filter(var %in% 'chla') %>% 
  dplyr::select(station, date, var, val) %>% 
  inner_join(locs, ., by = 'station') %>% 
  mutate(
    date = floor_date(date, unit = 'week')
  )

colfun <- colorBin(
  RColorBrewer::brewer.pal(9, 'Blues'),
  domain = c(0, max(chldat$val, na.rm = T)), 
  bins = 8,
  na.color = "#FFFFFF00" ,
  alpha = FALSE,
  reverse = FALSE
)

# chldat bbox
bbox <- chldat %>% 
  st_bbox %>% 
  st_as_sfc() %>% 
  st_as_sf() %>% 
  as_Spatial()

# empty grid for interpolation
grd <- as.data.frame(spsample(bbox, "regular", n = 200000))
names(grd) <- c("X", "Y")
coordinates(grd) <- c("X", "Y")
gridded(grd) <- TRUE  # Create SpatialPixel object
fullgrid(grd) <- TRUE  # Create SpatialGrid object
proj4string(grd) <- prj

wk <- chldat %>% 
  filter(date == as.Date('2021-04-04')) %>% 
  mutate(
    col = colfun(val)
  )

wkspa <- wk %>% 
  as_Spatial

# add crs to grid
proj4string(wkspa) <- prj

# interpolate
interp <- gstat::idw(val ~ 1, wkspa, newdata = grd, idp = 3.0) %>% 
  raster %>% 
  mask(segmask)
```

### Week of 2021-04-04

```{r, out.width = '100%'}
mapview(wk, homebutton = F, legend = F) %>% 
  .@map %>% 
  clearMarkers() %>% 
  addRasterImage(interp, colors = colfun) %>% 
  addCircleMarkers(
    data = wk,
    stroke = TRUE,
    color = 'black',
    fill = TRUE,
    fillColor = wk$col,
    weight = 0.5,
    fillOpacity = 1,
    radius= 3,
    label = ~val
  ) %>%
  addLegend("topright", title = 'Chla (ug/L)', opacity = 1, values = chldat$val, pal = colfun)
```