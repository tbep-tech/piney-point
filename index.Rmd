---
title: "PINEY POINT ENVIRONMENTAL MONITORING DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
    logo: www/tarponlogo.png
    social: menu
    source_code: "https://github.com/tbep-tech/piney-point"
runtime: shiny
css: styles.css
---
  
```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

# libraries
library(flexdashboard)
library(mapview)
library(leaflet)
library(tidyverse)
library(sf)
library(plotly)
library(leafem)
library(colorspace)
library(scales)
library(reactable)
library(tbeptools)

source('R/funcs.R')

load('data/bswqdat.RData')
load('data/bswqdatsub.RData')
load('data/bsstatloc.RData')
load('data/rswqdat.RData')
load('data/rsstatloc.RData')
load('data/parms.RData')
load('data/bstransect.RData')
load('data/bstransectocc.RData')
load('data/trnpts.RData')
load('data/trnlns.RData')

# log
log <- readLines('https://tbep-tech.github.io/piney-point/logs/indexlog.txt')

##
# globals

# map types
mptyps <- c("CartoDB.Positron", "CartoDB.DarkMatter", "OpenStreetMap", "Esri.WorldImagery", "OpenTopoMap")

# proj
prj <- 4326

# font
fml <- 'Lato Light'

# line colors on baseline
cols <- qualitative_hcl(length(unique(bswqdat$var)), palette = "Dynamic")

# station colors on maps
stacols <- qualitative_hcl(length(unique(rsstatloc$source_lng)), palette = "Dark2")
names(stacols) <- sort(unique(rsstatloc$source_lng))

# variable color on maps
vrscols <- rev(sequential_hcl(11, palette = 'Blues'))

# value box colors
boxcol <- '#00806E'

# piney point loc
pineypoint <- c(-82.52469352586753, 27.629819505234703)

# seagrass transect prj
st_crs(trnpts) <- 4326
st_crs(trnlns) <- 4326

# seagrass species
spp <- c("Halodule", "Syringodium", "Thalassia", "Halophila", "Ruppia", "Caulerpa")

# seagrass transects near pp
trns <- sort(unique(bstransect$Transect))

# sources lookup
srcs <- rsstatloc %>% 
  st_set_geometry(NULL) %>% 
  select(source_lng, source) %>% 
  unique

# variables to select from available
vrs <- parms %>% 
  select(lbs, var) %>% 
  filter(var %in% rswqdat$var) %>% 
  deframe %>% 
  as.list
```

```{r statics}
# response sampling locations
rslocs <- rsstatloc %>% 
  mutate(
    lon = st_coordinates(.)[, 1],
    lat = st_coordinates(.)[, 2]
  ) %>% 
  st_set_geometry(NULL) %>% 
  select(
    `Data source` = source_lng, 
    `Station` = station, 
    Longitude = lon, 
    Latitude = lat
  )

# baseline wq map
colsin <- stacols[unique(bsstatloc$source)]
bswqmap <- mapview(bsstatloc, zcol = 'source', homebutton = F, layer.name = 'Data source', col.regions = colsin, map.types = mptyps) %>% 
  addStaticLabels(label = bsstatloc$station,
                  noHide = TRUE,
                  direction = 'top',
                  textOnly = TRUE,
                  textsize = "20px", 
                  offset = c(0, 1)) %>% 
  addMarkers(lng = pineypoint[1], lat = pineypoint[2], label = 'Piney Point')

# response wqmap
rswqmap <- mapview(rsstatloc, zcol = 'source_lng', homebutton = F, layer.name = 'Data source', col.regions = stacols, map.types = mptyps) %>% 
  .@map %>% 
  addMarkers(lng = pineypoint[1], lat = pineypoint[2], label = 'Piney Point')

# summary of agencies reporting for value boxes
agns <- rswqdat %>% 
  pull(source) %>% 
  unique %>% 
  length

# summary of variables measured for value boxes
vars <- rswqdat %>% 
  pull(var) %>% 
  unique %>% 
  length

# summary of days of sampling for value boxes
dysm <- rswqdat %>% 
  pull(date) %>% 
  unique %>% 
  length

# summary of sites being monitored for value boxes
stsm <- rswqdat %>% 
  pull(station) %>% 
  unique %>% 
  length

# summary of samples for value boxes
smsm <- rswqdat %>% 
  nrow

# seagrass base map
sgmap <- mapview(trnpts, homebutton = F, legend = F) %>% 
  .@map %>% 
  clearMarkers() %>% 
  addCircleMarkers(
    data = trnpts,
    layerId = ~TRAN_ID,
    stroke = TRUE,
    color = 'black',
    fill = TRUE,
    fillColor = 'grey',
    weight = 1,
    fillOpacity = 1,
    radius= 4,
    label = ~paste0('Transect ', TRAN_ID, ' (Agency responsible: ', MonAgency, ')')
  ) %>% 
  addLabelOnlyMarkers(data = trnpts, ~0.99995 * LONG_DD, ~LAT_DD, label = ~TRAN_ID, labelOptions = labelOptions(
    noHide = T, 
    direction = 'auto', 
    textOnly = T,
    textsize = '15px',
    style = list(
      'color' = 'darkgreen'
    )
  )) %>% 
  addMarkers(lng = pineypoint[1], lat = pineypoint[2], label = 'Piney Point')
```

```{r reactives}
# complete time series, baseline data
baseplo1 <- reactive({
  
  # inputs
  stasel1 <- input$stasel1
  
  out <- plo_fun(bswqdat, stasel1, cols, parms)
  
  return(out)
  
})

# march/april time series, baseline data
baseplo2 <- reactive({
  
  # inputs
  stasel1 <- input$stasel1
  
  out <- plo_fun(bswqdatsub, stasel1, cols, parms)
  
  return(out)
  
})

# response data
rsdat1 <- reactive({
  
  # input
  varsel1 <- input$varsel1
  
  out <- rswqdat %>% 
    filter(var %in% varsel1) 

  return(out)
  
})

# color palette function
colfun <- reactive({
  
  # input
  rsdat1 <- rsdat1()
  
  req(rsdat1)
  
  # color palette function
  out <- colorNumeric(
    palette = vrscols,
    na.color = 'yellow',
      domain = range(rsdat1$val, na.rm = T)
    )
  
  return(out)
  
})
  
# response data table
rstab1 <- reactive({
  
  # input
  rsdat1 <- rsdat1()
  varsel1 <- input$varsel1
  
  req(rsdat1)
  
  # variable label
  vrlb <- names(vrs)[vrs == varsel1]
  
  totab <- rsdat1 %>% 
    left_join(parms, by = 'var') %>% 
    left_join(srcs, by = 'source') %>% 
    select(
      Source = source_lng,
      Station = station ,
      Date = date, 
      val
    ) %>% 
    arrange(desc(Date))
  names(totab)[names(totab) == 'val'] <- vrlb
  
  out <- reactable(totab,
    defaultColDef = colDef(
      footerStyle = list(fontWeight = "bold"),
      format = colFormat(separators = F),
      resizable = TRUE
    ),
    filterable = T,
    defaultPageSize = nrow(totab)
    )
  
  return(out)
  
})

# response data map
rsmap1 <- reactive({
  
  # input
  rsdat1 <- rsdat1()
  colfun <- colfun()
  varsel1 <- input$varsel1
  dyssel1 <- input$dyssel1
  
  req(dyssel1)

  # variable label
  vrlb <- names(vrs)[vrs == varsel1]
  
  # point sizing, colors
  rsdat1 <- rsdat1 %>% 
    mutate(
      cols = colfun(val),
      cexs = scales::rescale(val, to = c(4, 17))
    ) 
  
  # make sf
  tomap <- rsdat1 %>% 
    filter(date %in% dyssel1) %>% 
    inner_join(rsstatloc, ., by = c('source', 'station'))
  
  # hover pt labels
  labs <- paste0('Source: ', tomap$source_lng, ', Station: ', tomap$station, ', ', vrlb, ': ', round(tomap$val, 2))
  leglab <- vrlb

  if(nrow(tomap) == 0)
    m <- mapview()
   
  if(nrow(tomap) != 0)
    m <- mapview(tomap, cex = tomap$cexs, label = labs, legend = F, layer.name = F, col.regions = tomap$cols, homebutton = F, map.types = mptyps)
  
  # add legend
  out <- m@map %>% 
    addLegend("bottomright", pal = colfun, title = leglab, opacity = 1, values = rsdat1$val) %>% 
    setView(pineypoint[1], pineypoint[2], zoom = 12) %>% 
    addMarkers(lng = pineypoint[1], lat = pineypoint[2], label = 'Piney Point')
  
  return(out)
  
})

# seagrass map selection
bssgmap1 <- reactive({
  
  # input
  trnsel1 <- input$trnsel1
  
  toadd <- trnpts %>% 
    filter(TRAN_ID %in% trnsel1)
  mout <- sgmap %>% 
    addCircleMarkers(
      data = toadd,
      layerId = ~TRAN_ID,
      stroke = TRUE,
      color = 'black',
      fill = TRUE,
      fillColor = 'red',
      weight = 1,
      fillOpacity = 1,
      radius= 6,
      label = ~paste0('Transect ', TRAN_ID)
    ) %>% 
    setView(pineypoint[1], pineypoint[2], zoom = 12)
  
  return(mout)
  
})

# seagrass transect plot over time
bssgtrnplo1 <- reactive({
  
  # input
  trnsel1 <- input$trnsel1
  
  p <- show_transect(bstransect, site = trnsel1, species = spp, varplo = 'Abundance', plotly = T, base_size = 11, yrrng = c(1998, 2021)) %>% 
    layout(
      title = list(text = NA), 
      legend = list(title = list(text = 'Abundance (BB)'))
    )
  
  
  return(p)
  
})

# seagrass summary plot over time
bssgsumplo1 <- reactive({
  
  # input
  trnsel1 <- input$trnsel1
  
  p <- show_transectsum(bstransectocc, site = trnsel1, species = spp, yrrng = c(1998, 2021)) %>% 
    layout(
      title = list(text = NA),
      legend = list(title = list(text = NA)),
      xaxis = list(title = list(text = 'Year'))
    )
  
  return(p)
  
})
```

OVERVIEW
=======================================================================

Column {data-width=650}
-----------------------------------------------------------------------

### __DASHBOARD INFORMATION__

<div class = "row">
<div class = "col-md-2"></div>
<div class = "col-md-8">

####

```{r out.width='80%', fig.align='center'}
knitr::include_graphics('www/Piney_Dashboard_Header.png')
```

[__JUMP TO LATEST DATA__](https://shiny.tbep.org/piney-point/#section-water-quality-results), last update `r log`

The Tampa Bay Estuary Program is working with regional partners to coordinate and synthesize water quality, benthic, seagrass, and fisheries monitoring data. We are also consulting with USF to model forecasted plume trajectory from the Piney Point discharge. 

The primary pollutants of concern for this discharge are phosphorus and nitrogen (primarily ammonia nitrogen), which may stimulate an algae response and cause adverse effects on seagrass, fish, and other wildlife.

The dashboard is a synthesis of data that can be used to assess baseline conditions prior to discharge and to evaluate changing water quality conditions as new data become available. __All data are preliminary or provisional and are subject to revision.__ The dashboard is arranged as follows:

1) __BASELINE DATA__: Long-term water quality and seagrass data over a 25 year period.  These represent "baseline" conditions.
1) __CURRENT DATA__: Locations being sampled by our partners in response to current events.

#### Website information

The page source content can be viewed on [Github](https://github.com/tbep-tech/piney-point).

Questions and comments about the dashboard can be sent to [Marcus Beck](mailto:mbeck@tbep.org).

<a rel='license' href='http://creativecommons.org/licenses/by/4.0/'><img alt='Creative Commons License' style='border-width:0' src='https://i.creativecommons.org/l/by/4.0/88x31.png' /></a>&nbsp;&nbsp;This dashboard is licensed under a <a rel='license' href='http://creativecommons.org/licenses/by/4.0/'>Creative Commons Attribution 4.0 International License</a>.

[![DOI](https://zenodo.org/badge/353409644.svg)](https://zenodo.org/badge/latestdoi/353409644)

</div>
<div class = "col-md-2"></div>
</div>

WATER QUALITY RESULTS {data-navmenu="CURRENT DATA"}
=======================================================================

Column {data-width=400}
-----------------------------------------------------------------------

### __STATION LOCATIONS - PINEY POINT AT MARKER__

```{r}
output$rsmap1 <- renderLeaflet(rsmap1())
leafletOutput('rsmap1')
```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

<br>
```{r}
column(12,
  column(5, 
    selectInput('varsel1', 'Select variable:', choices = vrs, selected = 'nh3')       
  ), 
  column(7, 
    renderUI({
      
      # inputs
      varsel1 <- input$varsel1
      rsdat1 <- rsdat1()
      
      req(rsdat1)
      
      dys <- unique(rsdat1$date)
      
      sliderInput('dyssel1', 'Select date:', min = min(dys), max = max(dys), value = max(dys), animate = T, timeFormat="%m-%d", width = '100%')
  
    })     
  )
)
```

### __ALL DATA ARE PROVISIONAL__

```{r}
output$rstab1 <- renderReactable(rstab1())
reactableOutput('rstab1')
```

### __INFORMATION__


WATER QUALITY OVERVIEW {data-navmenu="CURRENT DATA" data-orientation=rows}
=======================================================================

Row
-----------------------------------------------------------------------

### __STATION LOCATIONS - PINEY POINT AT MARKER__

```{r}
rswqmap
```

Row
-----------------------------------------------------------------------

### 

```{r}
valueBox(agns, 'Agencies reporting', color = boxcol, icon = 'fa-university')
```

### 

```{r}
valueBox(vars, 'Parameters monitored', color = boxcol, icon = 'fa-vial')
```

### 

```{r}
valueBox(dysm, 'Days of sampling', color = boxcol, icon = 'fa-calendar')
```

### 

```{r}
valueBox(stsm, 'Sites with data', color = boxcol, icon = 'fa-map-marked')
```

### 

```{r}
valueBox(smsm, 'Samples processed', color = boxcol, icon = 'fa-tint')
```

WATER QUALITY {data-navmenu="BASELINE DATA"}
=======================================================================

Column {data-width=275}
-----------------------------------------------------------------------

### __STATION LOCATIONS - PINEY POINT AT MARKER__

```{r}
bswqmap
```

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

<br>
```{r}
column(12, 
  selectInput('stasel1', 'Select station:', choices = c('21', '22', '90', '336', '357', '361', '362'))
)
```

### __COMPLETE TIME SERIES__

```{r}
output$baseplo1 <- renderPlotly(baseplo1())
plotlyOutput('baseplo1')
```

### __MARCH, APRIL ONLY__

```{r}
output$baseplo2 <- renderPlotly(baseplo2())
plotlyOutput('baseplo2')
```

SEAGRASSES {data-navmenu="BASELINE DATA"}
=======================================================================

Column {data-width=275}
-----------------------------------------------------------------------

### __TRANSECT LOCATIONS - PINEY POINT AT MARKER__

```{r}
output$bssgmap1 <- renderLeaflet(bssgmap1())
leafletOutput('bssgmap1')
```

Column {data-width=650}
-----------------------------------------------------------------------

### __TRANSECT DATA__

```{r}
fillCol(flex = c(0.1, 1),
  column(12, 
    selectInput(inputId = 'trnsel1', label = 'Select transect:', choices = trns, selected = trns[1])
  ),
  fillCol(flex = c(1, 1),
    renderPlotly(bssgtrnplo1()),
    renderPlotly(bssgsumplo1())
  )
)
```
