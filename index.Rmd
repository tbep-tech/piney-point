---
title: "PINEY POINT ENVIRONMENTAL MONITORING DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
    logo: www/tarponlogo.png
    social: menu
    source_code: "https://github.com/tbep-tech/piney-point"
runtime: shiny
css: styles.css
---
  
```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

# libraries
library(flexdashboard)
library(mapview)
library(leaflet)
library(tidyverse)
library(sf)
library(plotly)
library(leafem)
library(colorspace)

source('R/funcs.R')

load('data/bswqdat.RData')
load('data/bswqdatsub.RData')
load('data/bsstatloc.RData')
load('data/rswqdat.RData')
load('data/rsstatloc.RData')
load('data/parms.RData')

# log
log <- readLines('https://tbep-tech.github.io/piney-point/logs/indexlog.txt')

# globals
cols <- qualitative_hcl(length(unique(bswqdat$var)), palette = "Dynamic")
stacols <- qualitative_hcl(length(unique(rsstatloc$source)), palette = "Dark2")
names(stacols) <- sort(unique(rsstatloc$source))
boxcol <- '#00806E'
pineypoint <- c(-82.52469352586753, 27.629819505234703)
```

```{r reactives}
# complete time series, baseline data
baseplo1 <- reactive({
  
  # inputs
  stasel1 <- input$stasel1
  
  out <- plo_fun(bswqdat, stasel1, cols, parms)
  
  return(out)
  
})

# march/april time series, baseline data
baseplo2 <- reactive({
  
  # inputs
  stasel1 <- input$stasel1
  
  out <- plo_fun(bswqdatsub, stasel1, cols, parms)
  
  return(out)
  
})
```

```{r statics}
# response sampling locations
rslocs <- rsstatloc %>% 
  mutate(
    lon = st_coordinates(.)[, 1],
    lat = st_coordinates(.)[, 2]
  ) %>% 
  st_set_geometry(NULL) %>% 
  select(
    `Data source` = source, 
    `Station name` = station, 
    Longitude = lon, 
    Latitude = lat
  )

# baseline wq map
colsin <- stacols[unique(bsstatloc$source)]
bswqmap <- mapview(bsstatloc, zcol = 'source', homebutton = F, layer.name = 'Data source', col.regions = colsin) %>% 
  addStaticLabels(label = bsstatloc$station,
                  noHide = TRUE,
                  direction = 'top',
                  textOnly = TRUE,
                  textsize = "20px", 
                  offset = c(0, 1)) %>% 
  addMarkers(lng = pineypoint[1], lat = pineypoint[2], label = 'Piney Point')

# response wqmap
rswqmap <- mapview(rsstatloc, zcol = 'source', homebutton = F, layer.name = 'Data source', col.regions = stacols) %>% 
  .@map %>% 
  addMarkers(lng = pineypoint[1], lat = pineypoint[2], label = 'Piney Point')

# summary of agencies reporting for value boxes
agns <- rswqdat %>% 
  pull(source) %>% 
  unique %>% 
  length

# summary of variables measured for value boxes
vars <- rswqdat %>% 
  pull(var) %>% 
  unique %>% 
  length

# summary of days of sampling for values boxes
dysm <- rswqdat %>% 
  pull(date) %>% 
  unique %>% 
  length

# summary of sites being monitored
stsm <- rswqdat %>% 
  pull(station) %>% 
  unique %>% 
  length #%>% 
  # paste(., 'of', length(unique(rsstatloc$station)))
```

OVERVIEW
=======================================================================

Column {data-width=650}
-----------------------------------------------------------------------

### DASHBOARD INFORMATION

<div class = "row">
<div class = "col-md-2"></div>
<div class = "col-md-8">

####

```{r out.width='80%', fig.align='center'}
knitr::include_graphics('www/Piney_Dashboard_Header.png')
```

The Tampa Bay Estuary Program is working with regional partners to coordinate and synthesize water quality, benthic, seagrass, and fisheries monitoring data. We are also consulting with USF to model forecasted plume trajectory from the Piney Point discharge. 

The primary pollutants of concern for this discharge are phosphorus and nitrogen (primarily ammonia nitrogen), which may stimulate an algae response and cause adverse effects on seagrass, fish, and other wildlife.

The dashboard is a synthesis of data that can be used to assess baseline conditions prior to discharge and to evaluate changing water quality conditions as new data become available. The dashboard is arranged as follows:

1) __BASELINE DATA__: Long-term water quality data over a 25 year period.  These represent "baseline" conditions.
1) __CURRENT DATA__: Locations being sampled by our partners in response to current events.

#### Website information

The page source content can be viewed on [Github](https://github.com/tbep-tech/piney-point).

Questions and comments about the dashboard can be sent to [Marcus Beck](mailto:mbeck@tbep.org).

<a rel='license' href='http://creativecommons.org/licenses/by/4.0/'><img alt='Creative Commons License' style='border-width:0' src='https://i.creativecommons.org/l/by/4.0/88x31.png' /></a>&nbsp;&nbsp;This dashboard is licensed under a <a rel='license' href='http://creativecommons.org/licenses/by/4.0/'>Creative Commons Attribution 4.0 International License</a>.

[![DOI](https://zenodo.org/badge/353409644.svg)](https://zenodo.org/badge/latestdoi/353409644)

</div>
<div class = "col-md-2"></div>
</div>

WATER QUALITY {data-navmenu="BASELINE DATA"}
=======================================================================

Column {data-width=275}
-----------------------------------------------------------------------

### STATION LOCATIONS - PINEY POINT AT MARKER

```{r}
bswqmap
```

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

<br>
```{r}
mainPanel(
  column(12, 
    selectInput('stasel1', 'Select station:', choices = c('21', '22', '90', '336', '357', '361', '362'))
  )
)
```

### COMPLETE TIME SERIES

```{r}
output$baseplo1 <- renderPlotly(baseplo1())
plotlyOutput('baseplo1')
```

### MARCH, APRIL ONLY

```{r}
output$baseplo2 <- renderPlotly(baseplo2())
plotlyOutput('baseplo2')
```

SEAGRASSES {data-navmenu="BASELINE DATA"}
=======================================================================

Column {data-width=275}
-----------------------------------------------------------------------



WATER QUALITY OVERVIEW {data-navmenu="CURRENT DATA"}
=======================================================================

Column {data-width=400}
-----------------------------------------------------------------------

### STATION LOCATIONS - PINEY POINT AT MARKER

```{r}
rswqmap
```


Row
-----------------------------------------------------------------------

### 

```{r}
valueBox(agns, 'Agencies reporting', color = boxcol, icon = 'fa-ship')
```

### 

```{r}
valueBox(vars, 'Parameters monitored', color = boxcol, icon = 'fa-vial')
```

### 

```{r}
valueBox(dysm, 'Days of sampling', color = boxcol, icon = 'fa-calendar')
```

### 

```{r}
valueBox(stsm, 'Sites with data', color = boxcol, icon = 'fa-map-marker')
```

### Last data update `r log`

```{r}
knitr::kable(rslocs)
```

WATER QUALITY RESULTS {data-navmenu="CURRENT DATA"}
=======================================================================

Column {data-width=400}
-----------------------------------------------------------------------