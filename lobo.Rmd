---
title: "LOBO CONTINUOUS MONITORING"
output: 
  flexdashboard::flex_dashboard:
  logo: www/tarponlogo.png
social: menu
source_code: "https://github.com/tbep-tech/piney-point"
runtime: shiny
css: styles.css
---
  
```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

# libraries
library(flexdashboard)
library(tidyverse)
library(shiny)
library(patchwork)
library(stargazer)
library(plotly)
library(mapview)
library(sf)
library(leaflet)
library(WtRegDO)

source('R/funcs.R')

# data
load(url('https://tbep-tech.github.io/piney-point/data/lobodat.RData'))
load(url('https://tbep-tech.github.io/piney-point/data/loboeco.RData'))

# log
log <- readLines('https://tbep-tech.github.io/piney-point/logs/lobolog.txt')

# variables to select
vrs <- list(
  `Salinity (psu)` = 'Sal', 
  `Water temp (C)` = 'Temp', 
  `CO2 (ppm)` = 'co2', 
  `DO (ml/L)` = 'DO_obs', 
  `pH` = 'ph',
  `PAR (um/m2/s)` = 'par',
  `Tide (dbar)` = 'Tide',
  `Air temp (C)` = 'ATemp', 
  `Air pressure (mb)` = 'BP',
  `Wind speed (m/s)` = 'WSpd'
)

buoylat <- 27.6594677
buoylng <- -82.6043877
# date range on input data
dtrng <- range(lobodat$DateTimeStamp) %>% 
  as.Date
```

```{r reactives}
# data selection
datsel <- reactive({
  
  # inputs
  varsel1 <- input$varsel1
  varsel2 <- input$varsel2
  dtsel <- input$dtsel
  
  out <- lobodat %>% 
    select(DateTimeStamp, !!varsel1, !!varsel2) %>% 
    filter(as.Date(DateTimeStamp) >= dtsel[1] & as.Date(DateTimeStamp) <= dtsel[2])

  return(out)
  
})

# ecometab data selection
ecosel <- reactive({
  
  # inputs
  dtsel <- input$dtsel
  
  out <- loboeco %>% 
    filter(as.Date(Date) >= dtsel[1] & as.Date(Date) <= dtsel[2])

  return(out)
  
})

# time series and scatter plot
tsplo <- reactive({
  
  # inputs
  varsel1 <- input$varsel1
  varsel2 <- input$varsel2
  datsel <- datsel()
  
  lb1 <- names(vrs)[which(unlist(vrs) == varsel1)]
  lb2 <- names(vrs)[which(unlist(vrs) == varsel2)]
  browser()
  p1 <- ggplot(datsel, aes_string(x = 'DateTimeStamp', y = varsel1)) + 
    geom_line() + 
    geom_point() + 
    theme_minimal(base_size = 16) + 
    labs(y = lb1) + 
    theme(
      axis.title.x = element_blank()
    )
  
  p2 <- ggplot(datsel, aes_string(x = 'DateTimeStamp', y = varsel2)) + 
    geom_line() + 
    geom_point() + 
    theme_minimal(base_size = 16) + 
    labs(y = lb2) + 
    theme(
      axis.title.x = element_blank()
    )
  
  p3 <- ggplot(datsel, aes_string(x = varsel1, y = varsel2))+ 
    geom_point()+ 
    theme_minimal(base_size = 16) + 
    labs(x = lb1, y = lb2) + 
    geom_smooth(method = 'lm')
  
  p <- (p1 / p2) | p3
  
  return(p)
  
})

# ecometab plot
ecoplo <- reactive({
  
  # input
  ecosel <- ecosel()
  
  out <- plot(ecosel, by = 'days') + 
    theme_bw(base_size = 20)
  
  return(out)
  
})

# linear mod
lmstat <- reactive({
  
  # inputs
  varsel1 <- input$varsel1
  varsel2 <- input$varsel2
  datsel <- datsel()

  frm <- paste(varsel2, varsel1, sep = '~') %>% 
    as.formula
  
  out <- lm(frm, datsel)
  
  return(out)
  
})

# pearson
corstat <- reactive({
 
  # inputs
  varsel1 <- input$varsel1
  varsel2 <- input$varsel2
  datsel <- datsel()

  corv <- cor.test(datsel[[varsel1]], datsel[[varsel2]])
  
  out <- paste0('r = ', round(corv$estimate, 2), ', p ', format.pval(corv$p.value))
  
  return(out) 
  
})

output$lmstat <- renderText(stargazer(lmstat(), type = 'html', digits = 2))
output$corstat <- renderText(corstat())

```


TIME SERIES COMPARISONS
=======================================================================
  
Column {data-width=200 .tabset .tabset-fade}
-----------------------------------------------------------------------
  
### Data selection

```{r}
column(12, 
  selectInput('varsel1', 'Select first variable:', choices = vrs, selected = vrs[4])
)

column(12, 
  selectInput('varsel2', 'Select second variable:', choices = vrs, selected = vrs[5])
)

column(12, 
  sliderInput('dtsel', 'Select date range:', min = dtrng[1], max =  dtrng[2], value = dtrng, timeFormat="%Y-%m-%d")
)

HTML('<br>')
fillCol(flex = c(NA, NA),
  column(12,
    'Regression summary:',
    uiOutput('lmstat')
  ),

  column(12, 
    'Correlation summary:', 
    uiOutput('corstat')
  ) 
  
)
```

### About


```{r}
loc <- data.frame(
  lat = buoylat,
  lon = buoylng
  ) %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = 4326)

txt <- HTML('Data on this dashboard are from the <a href="http://tampabay.loboviz.com/">Tampa Bay LOBO</a> (Land/Ocean Biogeochemical Observatory) continuous monitoring buoy, located in Lower Tampa Bay. Co-located weather observations (wind, air temperature, pressure) are from <a href="http://tbports.org/">http://tbports.org/</a>, with data from station <a href="https://tidesandcurrents.noaa.gov/met.html?id=8726412">8726412</a>. All data are preliminary or provisional and are subject to revision. The data have not received final approval by the USGS and are provided on the condition that neither the USGS nor the U.S. Government shall be held liable for any damages resulting from the authorized or unauthorized use of the data.  Approximate buoy location:')

m <- mapview(loc, homebutton = F, legend = F)@map %>% 
  setView(lat = buoylat, lng = buoylng, zoom = 10)

fillCol(flex = c(NA, 1), txt, m)
```


Column {.tabset .tabset-fade data-width=700}
-----------------------------------------------------------------------

### `r paste0('Data current as of ', log)`

```{r}
output$tsplo <- renderPlot(tsplo())
plotOutput('tsplo')
```

### Odum open-water metabolism

```{r}
output$ecoplo <- renderPlot(ecoplo())
plotOutput('ecoplo')
```

